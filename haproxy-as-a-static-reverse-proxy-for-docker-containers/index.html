<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>HAProxy as a static reverse proxy for Docker containers | oskarhane</title>
  <meta name="author" content="Oskar Hane">
  
  <meta name="description" content="I like Docker. A lot.  
Everything I build and deploy now ends up in their own container on some server/VPS of mine. One reason for this is because of how easy it is to move the site or service to another server if needed. Just export and import the Docker container and you’re done. No config on web and database servers needed, it’s all done.
But there’s one thing you need to do. You can’t have lots of containers listening on the same public port 80, so you have to have your containers listening on some random port like 4553, 4566, 4333 etc. But your site’s visitors are coming to port 80 so you need to somehow listen to port 80 and forward requests to the right Docker container on the right port.
There are several ways to do this and I started out with Nginx as a reverse proxy. This works fine but I don’t want a web server doing that. I’ve used HAProxy in the past for load balancing. And it is actually just what I need, a load balancer is made for forwarding requests.">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="HAProxy as a static reverse proxy for Docker containers"/>
  <meta property="og:site_name" content="oskarhane"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="oskarhane" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="aligncenter">
  <img src="/post_img/oh-logo-05.png" class="header-logo">
  <h1><a href="/">oskarhane</a></h1>
  <h2><a href="/"></a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-02-25T08:59:52.000Z"><a href="/haproxy-as-a-static-reverse-proxy-for-docker-containers/">2014-02-25</a></time>
      
      
  
    <h1 class="title">HAProxy as a static reverse proxy for Docker containers</h1>
  

    </header>
    <div class="entry">
      
        <p>I like <a href="https://www.docker.io" target="_blank" rel="external">Docker</a>. A lot.  </p>
<p>Everything I build and deploy now ends up in their own container on some server/VPS of mine. One reason for this is because of how easy it is to move the site or service to another server if needed. Just export and import the Docker container and you’re done. No config on web and database servers needed, it’s all done.</p>
<p>But there’s one thing you need to do. You can’t have lots of containers listening on the same public port 80, so you have to have your containers listening on some random port like 4553, 4566, 4333 etc. But your site’s visitors are coming to port 80 so you need to somehow listen to port 80 and forward requests to the right Docker container on the right port.</p>
<p>There are several ways to do this and I started out with Nginx as a reverse proxy. This works fine but I don’t want a web server doing that. I’ve used <a href="http://haproxy.1wt.eu" target="_blank" rel="external">HAProxy</a> in the past for load balancing. And it is actually just what I need, a load balancer is made for forwarding requests.</p>
<a id="more"></a>  
<p>So here’s how you use it as a reverse proxy for your docker containers.</p>
<h3 id="Install_HAProxy_(Debian)">Install HAProxy (Debian)</h3><pre><code>sudo apt-<span class="keyword">get</span> install haproxy
</code></pre><h3 id="Edit_config_file">Edit config file</h3><pre><code>sudo nano /etc/haproxy<span class="class">.cfg</span>

<span class="comment">//Put this in the file</span>
global
    daemon
    maxconn <span class="number">4096</span>

defaults
    mode http
    timeout connect <span class="number">5000ms</span>
    timeout client <span class="number">50000ms</span>
    timeout server <span class="number">50000ms</span>

frontend http-<span class="keyword">in</span>
    bind *:<span class="number">80</span>
    acl is_site1 <span class="function"><span class="title">hdr_end</span><span class="params">(host)</span></span> -<span class="tag">i</span> domain1<span class="class">.se</span>
    acl is_site2 <span class="function"><span class="title">hdr_end</span><span class="params">(host)</span></span> -<span class="tag">i</span> domain2<span class="class">.com</span>

    use_backend site1 <span class="keyword">if</span> is_site1
    use_backend site2 <span class="keyword">if</span> is_site2

backend site1
    balance roundrobin
    option httpclose
    option forwardfor
    server s2 <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">49153</span> maxconn <span class="number">32</span>

backend site2
    balance roundrobin
    option httpclose
    option forwardfor
    server s1 <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">2082</span> maxconn <span class="number">32</span>

listen admin
    bind <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8080</span>
    stats enable
</code></pre><h3 id="Start/Restart_HAProxy">Start/Restart HAProxy</h3><pre><code>sudo <span class="regexp">/usr/</span>sbin<span class="regexp">/haproxy -f /</span>etc<span class="regexp">/haproxy.cfg -D -p /</span>var<span class="regexp">/run/</span>haproxy.pid
</code></pre><p>There are lots more stuff you can do with HAProxy but this is a basic forwarding proxy.</p>
<p>The only downside with this is that it’s static and any change in ports needs to manually be updated in HAProxy config file.</p>
<p><strong>EDIT</strong>  </p>
<p>I’ve created a post on how you can automate this with Nginx config files, <a href="/nginx-as-a-reverse-proxy-in-front-of-your-docker-containers/">Nginx as a reverse proxy in front of your docker containers &gt;&gt;</a></p>

      
    </div>
    <footer>
      
        
        
  
  <div class="tags">
    <a href="/tags/General/">General</a>, <a href="/tags/Impressive/">Impressive</a>, <a href="/tags/Server-Side/">Server Side</a>
  </div>

        
  <div class="addthis addthis_toolbox addthis_default_style">
    
      <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    
    
      <a class="addthis_button_tweet"></a>
    
    
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">Comments</h1>

  
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
  
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  <div class="widget tag">
  <img width="100%" height="auto" src="/post_img/2013/02/4f339050f44c11e1a3461231381315e1_7.jpg">
    <h3 class="title"> MY LIFE CONSISTS OF…</h3>
      <p class="entry">
        ... coding, family, humor, and general whining about stuff that's not done right.
        <br>
        I'm an introvert (<a href="http://www.typelogic.com/intp.html">INTP</a>) who loves to program, build stuff, and solve problems.
        <br>Works @ <a href="http://neo4j.com/">Neo4j</a>.
        <br>I can be reached at <a href="http://twitter.com/oskarhane">@oskarhane</a>, &nbsp; <a href="http://www.facebook.com/ohane">ohane</a>
        &nbsp; and &nbsp;
        <a href="mailto:blog@oskrhane.com">blog@oskarhane.com</a>.
      </p>
</div>

  
<div class="widget tag">
  <h3 class="title">Recent Posts</h3>
  <ul class="entry">
    
      <li>
        <a href="/angular-bootstrap-jade-stylus-coffeescript-boilerplate-webapp-with-yeoman/">Angular - Bootstrap - Jade - Stylus - CoffeeScript boilerplate webapp with Yeoman</a>
      </li>
    
      <li>
        <a href="/again-add-authorization-header-to-angularjs-http/">Again: Add Authorization header to AngularJS $http</a>
      </li>
    
      <li>
        <a href="/add-authorization-header-to-angularjs-http/">Add Authorization header to AngularJS $http</a>
      </li>
    
      <li>
        <a href="/create-a-nested-array-recursively-in-coffeescript/">Create a nested array recursively in CoffeeScript</a>
      </li>
    
      <li>
        <a href="/angularjs-watch-and-timeout/">AngularJS: $watch and $timeout</a>
      </li>
    
      <li>
        <a href="/neo4j-docker-image/">Neo4j Docker Image</a>
      </li>
    
      <li>
        <a href="/two-factor-auth-for-wordpress-5000-downloads/">Two Factor Auth for Wordpress &gt; 5000 downloads</a>
      </li>
    
      <li>
        <a href="/today-im-joining-the-neo4j-team/">Today I&#39;m joining the Neo4j team!</a>
      </li>
    
      <li>
        <a href="/note-to-self-on-updating-wordpress-plugins-via-git-svn/">Note to self on updating Wordpress plugins via git-svn</a>
      </li>
    
      <li>
        <a href="/use-your-synology-as-a-local-dns-cache/">Use your Synology as a local DNS cache</a>
      </li>
    
      <li>
        <a href="/maker-how-i-did-a-fishing-lure-jerk-bait/">Make:r - How I did a fishing lure / jerk bait </a>
      </li>
    
      <li>
        <a href="/angular-js-filter-to-make-urls-in-text-clickable/">Angular.JS filter to make url:s in text clickable</a>
      </li>
    
      <li>
        <a href="/proxy-app-a-native-proxy-for-os-x/">Proxy.app - A native proxy for OS X</a>
      </li>
    
      <li>
        <a href="/does-that-html5-css3-thing-work-in/">Does that HTML5/ CSS3 thing work in ...?</a>
      </li>
    
      <li>
        <a href="/docker-image-wordpress-nginx-ssh-updated/">Docker image &quot;Wordpress NGiNX SSH&quot; updated</a>
      </li>
    
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">Tags</h3>
  <ul class="entry">
  
    <li><a href="/tags/BitCoin/">BitCoin</a><small>2</small></li>
  
    <li><a href="/tags/Client-Side/">Client Side</a><small>34</small></li>
  
    <li><a href="/tags/Coding/">Coding</a><small>54</small></li>
  
    <li><a href="/tags/Crypto/">Crypto</a><small>11</small></li>
  
    <li><a href="/tags/Docker/">Docker</a><small>4</small></li>
  
    <li><a href="/tags/Food/">Food</a><small>2</small></li>
  
    <li><a href="/tags/General/">General</a><small>20</small></li>
  
    <li><a href="/tags/Hacks/">Hacks</a><small>17</small></li>
  
    <li><a href="/tags/Humor/">Humor</a><small>5</small></li>
  
    <li><a href="/tags/Impressive/">Impressive</a><small>13</small></li>
  
    <li><a href="/tags/Node-js/">Node.js</a><small>11</small></li>
  
    <li><a href="/tags/PHP/">PHP</a><small>5</small></li>
  
    <li><a href="/tags/Raspberry-Pi/">Raspberry Pi</a><small>5</small></li>
  
    <li><a href="/tags/Server-Side/">Server Side</a><small>59</small></li>
  
    <li><a href="/tags/Training/">Training</a><small>7</small></li>
  
    <li><a href="/tags/Whine/">Whine</a><small>6</small></li>
  
    <li><a href="/tags/WordPress/">WordPress</a><small>17</small></li>
  
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'oskarhane';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


<!-- Piwik -->
<script type="text/javascript">
  var _paq = _paq || [];
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//piwik.hanehub.com/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', 1]);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript><p><img src="//piwik.hanehub.com/piwik.php?idsite=1" style="border:0;" alt="" /></p></noscript>
<!-- End Piwik Code -->

</body>
</html>